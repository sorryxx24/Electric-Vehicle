<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å‹•è»Šå®‰å…¨æ•‘æ´è¨“ç·´çµ±è¨ˆç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        // ==========================================
        // âš ï¸ã€è«‹ä¿®æ”¹é€™è£¡ã€‘å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbznRUBnv-opvKuHv1rjyx8vn_p26GebhBSlx-1VmZ-euXqlsywXsix2KY0GSx6guL0/exec";
        // ==========================================

        // â˜… æ ¸å¿ƒè³‡æ–™ï¼š57 å€‹æ‡‰å¡«å ±å–®ä½ (å·²æ’é™¤ 4 å€‹é«˜æ•‘åˆ†éšŠ)
        const AUDIT_UNITS = {
            "ç¬¬ä¸€å¤§éšŠ": {
                "æœ¬éƒ¨": ["ç¬¬ä¸€æ•‘ç½æ•‘è­·å¤§éšŠ"],
                "ä¸­æ­£ä¸­éšŠ": ["ä¸­æ­£ä¸­éšŠ", "è¯å±±åˆ†éšŠ", "æ³‰å·åˆ†éšŠ", "å¤äº­åˆ†éšŠ", "åŸä¸­åˆ†éšŠ"], // æ’é™¤å¿ å­
                "è¬è¯ä¸­éšŠ": ["è¬è¯ä¸­éšŠ", "é›™åœ’åˆ†éšŠ", "é¾å±±åˆ†éšŠ"],
                "æ–‡å±±ä¸­éšŠ": ["æ–‡å±±ä¸­éšŠ", "è¬èŠ³åˆ†éšŠ", "æ™¯ç¾åˆ†éšŠ", "æœ¨æŸµåˆ†éšŠ", "å¯¶æ©‹åˆ†éšŠ"]
            },
            "ç¬¬äºŒå¤§éšŠ": {
                "æœ¬éƒ¨": ["ç¬¬äºŒæ•‘ç½æ•‘è­·å¤§éšŠ"],
                "å¤§å®‰ä¸­éšŠ": ["å¤§å®‰ä¸­éšŠ", "é‡‘è¯åˆ†éšŠ", "å¾©èˆˆåˆ†éšŠ", "å®‰å’Œåˆ†éšŠ"],
                "ä¿¡ç¾©ä¸­éšŠ": ["ä¿¡ç¾©ä¸­éšŠ", "ä¿¡ç¾©åˆ†éšŠ", "èŠæ•¬åˆ†éšŠ"], // æ’é™¤æ°¸å‰
                "å—æ¸¯ä¸­éšŠ": ["å—æ¸¯ä¸­éšŠ", "å—æ¸¯åˆ†éšŠ", "èˆŠèŠåˆ†éšŠ", "æˆå¾·åˆ†éšŠ"]
            },
            "ç¬¬ä¸‰å¤§éšŠ": {
                "æœ¬éƒ¨": ["ç¬¬ä¸‰æ•‘ç½æ•‘è­·å¤§éšŠ"],
                "ä¸­å±±ä¸­éšŠ": ["ä¸­å±±ä¸­éšŠ", "å¤§ç›´åˆ†éšŠ", "åœ“å±±åˆ†éšŠ", "æ¾æ±Ÿåˆ†éšŠ"], // æ’é™¤å»ºåœ‹
                "æ¾å±±ä¸­éšŠ": ["æ¾å±±ä¸­éšŠ", "ä¸­å´™åˆ†éšŠ", "å…«å¾·åˆ†éšŠ"],
                "å…§æ¹–ä¸­éšŠ": ["å…§æ¹–ä¸­éšŠ", "æ°‘æ¬Šåˆ†éšŠ", "å…§æ¹–åˆ†éšŠ", "å¤§æ¹–åˆ†éšŠ", "æ±æ¹–åˆ†éšŠ"]
            },
            "ç¬¬å››å¤§éšŠ": {
                "æœ¬éƒ¨": ["ç¬¬å››æ•‘ç½æ•‘è­·å¤§éšŠ"],
                "å¤§åŒä¸­éšŠ": ["å¤§åŒä¸­éšŠ", "å»ºæˆåˆ†éšŠ", "å»¶å¹³åˆ†éšŠ", "å¤§åŒåˆ†éšŠ"],
                "å£«æ—ä¸­éšŠ": ["å£«æ—ä¸­éšŠ", "å±±ä»”ååˆ†éšŠ", "å¤©æ¯åˆ†éšŠ", "ç¦å®‰åˆ†éšŠ", "ç¤¾å­åˆ†éšŠ", "åŠæ½­åˆ†éšŠ", "é›™æºªåˆ†éšŠ"], // æ’é™¤å¾Œæ¸¯
                "åŒ—æŠ•ä¸­éšŠ": ["åŒ—æŠ•ä¸­éšŠ", "é™½æ˜å±±åˆ†éšŠ", "å…‰æ˜åˆ†éšŠ", "é—œæ¸¡åˆ†éšŠ", "çŸ³ç‰Œåˆ†éšŠ", "ç§€å±±åˆ†éšŠ"]
            }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .sidebar-link { cursor: pointer; transition: all 0.2s; }
        .sidebar-link.active { background: rgba(37, 99, 235, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        .sidebar-link:hover:not(.active) { background: #1e293b; color: white; }
        .table-wrapper { flex: 1; min-height: 0; overflow: auto; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; min-width: 1100px; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8fafc; color: #475569; font-weight: 700; padding: 10px; border: 1px solid #cbd5e1; font-size: 14px; position: sticky; top: 0; z-index: 10; }
        td { border: 1px solid #cbd5e1; height: 42px; padding: 0; vertical-align: middle; background: white; }
        input { width: 100%; height: 100%; border: none; text-align: center; outline: none; background: transparent; }
        input:focus { background: #eff6ff; }
        .example-row td { background: #f1f5f9; color: #94a3b8; font-style: italic; pointer-events: none; }
        .btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: 0.2s; font-size: 14px; }
        .btn-blue { background: #2563eb; color: white; } .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #059669; color: white; } .btn-green:hover { background: #047857; }
        .btn-white { background: white; border: 1px solid #cbd5e1; color: #475569; } .btn-white:hover { background: #f8fafc; border-color: #94a3b8; color: #2563eb; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .day-cell { padding: 8px; text-align: center; border-radius: 6px; cursor: pointer; border: 1px solid #e2e8f0; font-size: 14px; background: white; }
        .day-cell.selected { background: #3b82f6; color: white; font-weight: bold; }
        .day-cell.weekend { color: #ef4444; }
        .gallery-card { break-inside: avoid; margin-bottom: 1.5rem; transition: transform 0.2s; }
        .gallery-card:hover { transform: translateY(-4px); }
        
        /* ç¨½æ ¸ç´…ç¶ ç‡ˆæ¨£å¼ */
        .audit-card { padding: 8px 12px; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; background: white; display: flex; justify-content: space-between; align-items: center; }
        .audit-card:hover { background-color: #f8fafc; border-color: #94a3b8; }
        .audit-card.checked { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
        
        /* è­¦å‘Š Banner */
        #alertBanner { transition: all 0.5s ease-in-out; }
        #alertBanner.hidden { display: none; }

        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden">
    <div id="loading"><div class="spinner mb-4"></div><div class="font-bold text-lg" id="loadingText">è³‡æ–™è™•ç†ä¸­...</div></div>

    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-2xl z-20 shrink-0">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg"><i class="ri-charging-pile-2-line text-xl"></i></div>
            <div><h1 class="font-bold text-lg tracking-wide">é›»å‹•è»Šè¨“ç·´</h1><p class="text-xs text-slate-400">çµ±è¨ˆç®¡ç†ç³»çµ±</p></div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div onclick="switchPage('input')" id="nav-input" class="sidebar-link active px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-edit-2-line text-xl"></i> æ–°å¢ä½œæ¥­å€</div>
            <div onclick="switchPage('audit')" id="nav-audit" class="sidebar-link px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-checkbox-circle-line text-xl text-yellow-400"></i> å¡«å ±ç¨½æ ¸</div>
            <div onclick="switchPage('history')" id="nav-history" class="sidebar-link px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-database-2-line text-xl"></i> æ­·å²è³‡æ–™åº«</div>
            <div onclick="switchPage('gallery')" id="nav-gallery" class="sidebar-link px-4 py-3 rounded-xl flex items-center gap-3 cursor-pointer"><i class="ri-gallery-view-2 text-xl text-sky-400"></i> æˆæœå±•ç¤º</div>
        </nav>
        <div class="p-4 border-t border-slate-800 text-center text-xs text-slate-500">v2.5 (æ’é™¤é«˜æ•‘éšŠ)</div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative min-w-0">
        <!-- æ‰‹æ©Ÿ Header ç•¥ -->

        <!-- â˜… é ‚éƒ¨è­¦å‘Š Banner (æœªçµæ¡ˆæé†’) -->
        <div id="alertBanner" class="bg-rose-50 border-b border-rose-200 px-6 py-3 flex items-start gap-3 hidden">
            <i class="ri-alarm-warning-fill text-rose-500 text-xl mt-0.5"></i>
            <div class="flex-1">
                <h3 class="font-bold text-rose-800 text-sm mb-1" id="alertTitle">114å¹´1æœˆ å°šæœªçµæ¡ˆæé†’</h3>
                <div class="text-xs text-rose-600 leading-relaxed" id="alertContent">è¼‰å…¥ä¸­...</div>
            </div>
            <button onclick="$('#alertBanner').classList.add('hidden')" class="text-rose-400 hover:text-rose-700"><i class="ri-close-line text-lg"></i></button>
        </div>

        <!-- A: æ–°å¢ä½œæ¥­å€ -->
        <div id="page-input" class="flex-1 flex flex-col p-6 overflow-hidden h-full">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <div class="flex items-center gap-2"><span class="w-1 h-6 bg-blue-600 rounded-full"></span><h2 class="text-xl font-bold text-slate-800">æ–°å¢ä½œæ¥­å€</h2></div>
                <div class="flex gap-2">
                    <button class="btn btn-white" onclick="downloadTemplate()"><i class="ri-file-download-line"></i> ä¸‹è¼‰ç¯„æœ¬</button>
                    <button class="btn btn-white" onclick="$('#csvInput').click()"><i class="ri-upload-2-line"></i> åŒ¯å…¥</button>
                    <button class="btn btn-blue" onclick="saveToCloud()"><i class="ri-cloud-upload-line"></i> å„²å­˜</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="inputTable">
                    <thead><tr><th style="width:50px">åˆª</th><th style="width:50px">åº</th><th style="width:220px">æ—¥æœŸ</th><th style="width:150px">å–®ä½</th><th style="width:200px">åœ°é»</th><th style="width:200px">é …ç›®</th><th style="width:80px">å ´æ¬¡</th><th style="width:80px">äººæ•¸</th><th style="width:150px">å‚™è¨»</th></tr></thead>
                    <tbody id="inputBody"></tbody>
                    <tfoot class="example-row"><tr><td></td><td>Ex</td><td>114å¹´1æœˆ1æ—¥</td><td>ä¿¡ç¾©ä¸­éšŠ</td><td>é§åœ°</td><td>è¨“ç·´</td><td>1</td><td>20</td><td></td></tr></tfoot>
                </table>
            </div>
            <div class="mt-4 flex justify-center shrink-0"><button class="btn btn-white" onclick="addInputRow()"><i class="ri-add-line"></i> æ–°å¢ä¸€åˆ—</button></div>
        </div>

        <!-- â˜… B: å¡«å ±ç¨½æ ¸ (åµŒå…¥å¼) -->
        <div id="page-audit" class="hidden flex-1 flex-col p-6 overflow-hidden h-full bg-slate-50">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-6 bg-yellow-500 rounded-full"></span>
                    <div><h2 class="text-xl font-bold text-slate-800">å¡«å ±ç¨½æ ¸ç¢ºèª</h2><p class="text-xs text-slate-500 mt-0.5" id="auditMonthLabel">çµ±è¨ˆæœˆä»½ï¼š...</p></div>
                </div>
                <button class="btn btn-white" onclick="loadHistory(true)"><i class="ri-refresh-line"></i> é‡æ–°æª¢æŸ¥</button>
            </div>

            <!-- æ“ä½œå€ -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">1. é¸æ“‡å¤§éšŠ</label>
                        <select id="selBat" onchange="renderSquadSelect()" class="w-full border border-slate-300 rounded-lg p-2 text-sm font-bold bg-slate-50"><option value="">è«‹é¸æ“‡...</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">2. é¸æ“‡ä¸­éšŠ (æˆ–å…¨éƒ¨)</label>
                        <select id="selSquad" onchange="renderUnitCheckboxes()" class="w-full border border-slate-300 rounded-lg p-2 text-sm font-bold bg-slate-50" disabled><option value="">è«‹å…ˆé¸å¤§éšŠ</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">3. é¸æ“‡ç‹€æ…‹</label>
                        <div class="flex gap-2">
                            <label class="flex-1 cursor-pointer border border-emerald-200 bg-emerald-50 rounded-lg p-2 flex items-center justify-center gap-2 hover:bg-emerald-100">
                                <input type="radio" name="auditType" value="å·²å¡«å¯«" checked class="text-emerald-600"> <span class="text-sm font-bold text-emerald-700">å·²å¡«å¯«</span>
                            </label>
                            <label class="flex-1 cursor-pointer border border-blue-200 bg-blue-50 rounded-lg p-2 flex items-center justify-center gap-2 hover:bg-blue-100">
                                <input type="radio" name="auditType" value="æœ¬æœˆç„¡æ›´æ–°" class="text-blue-600"> <span class="text-sm font-bold text-blue-700">æœ¬æœˆç„¡æ›´æ–°</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- å‹¾é¸å€ -->
                <div id="unitCheckArea" class="border-t border-slate-100 pt-4 hidden">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-slate-400">è«‹å‹¾é¸è¦ç¢ºèªçš„å–®ä½ï¼š</span>
                        <button onclick="toggleAllUnits()" class="text-xs text-blue-500 font-bold hover:underline">å…¨é¸ / åé¸</button>
                    </div>
                    <div id="unitCheckboxGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-4"></div>
                    <div class="flex justify-end">
                        <button onclick="submitAudit()" class="btn btn-blue shadow-lg px-6">é€å‡ºç¢ºèª <i class="ri-send-plane-fill ml-1"></i></button>
                    </div>
                </div>
            </div>

            <!-- å·²ç¢ºèªæ¸…å–® -->
            <div class="flex-1 overflow-y-auto">
                <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2"><i class="ri-history-line"></i> æœ¬æœˆå·²ç¢ºèªç´€éŒ„</h3>
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-bold"><tr><th class="px-4 py-2">å–®ä½</th><th class="px-4 py-2">ç‹€æ…‹</th><th class="px-4 py-2">ç¢ºèªæ™‚é–“</th></tr></thead>
                        <tbody id="auditLogBody" class="divide-y divide-slate-100"><tr><td colspan="3" class="p-4 text-center text-slate-400">å°šç„¡ç´€éŒ„</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- C: æ­·å²è³‡æ–™åº« -->
        <div id="page-history" class="hidden flex-col p-6 overflow-hidden h-full">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <div class="flex items-center gap-2"><span class="w-1 h-6 bg-emerald-600 rounded-full"></span><h2 class="text-xl font-bold text-slate-800">æ­·å²è³‡æ–™åº«</h2></div>
                <div class="flex gap-2">
                    <button class="btn btn-white" onclick="loadHistory()"><i class="ri-refresh-line"></i> é‡æ•´</button>
                    <button class="btn btn-green" onclick="exportExcel('full')"><i class="ri-file-excel-2-line"></i> åŒ¯å‡º</button>
                </div>
            </div>
            <div class="bg-emerald-50 border border-emerald-100 px-4 py-3 rounded-xl mb-4 flex gap-6 text-sm text-emerald-800 font-bold shadow-sm shrink-0">
                <div>ç¸½å ´æ¬¡ï¼š<span id="histTotalSession">0</span></div><div>ç¸½äººæ•¸ï¼š<span id="histTotalPeople">0</span></div>
            </div>
            <div class="table-wrapper flex-1 min-h-0 overflow-auto bg-white border border-slate-200 rounded-lg shadow-sm">
                <table id="historyTable">
                    <thead><tr><th style="width:60px">é …æ¬¡</th><th style="width:220px">æ—¥æœŸ</th><th style="width:120px">å–®ä½</th><th style="width:150px">åœ°é»</th><th style="width:200px">é …ç›®</th><th style="width:60px">å ´æ¬¡</th><th style="width:60px">äººæ•¸</th><th style="width:120px">å‚™è¨»</th><th style="width:100px">ç…§ç‰‡</th></tr></thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>

        <!-- D: æˆæœå±•ç¤º (ç•¥) -->
        <div id="page-gallery" class="hidden flex-1 flex-col p-6 overflow-hidden h-full bg-slate-50">
            <div class="flex justify-between items-center mb-6 shrink-0">
                <div class="flex items-center gap-2"><span class="w-1 h-6 bg-yellow-400 rounded-full"></span><h2 class="text-xl font-bold text-slate-800">æˆæœå±•ç¤ºç‰†</h2></div>
                <button id="btnGalleryRandom" class="btn btn-white" onclick="renderGallery()">ğŸ² é‡æ–°éš¨æ©Ÿ</button>
            </div>
            <div class="flex-1 overflow-y-auto min-h-0 pr-2"><div class="columns-1 md:columns-3 gap-6 space-y-6" id="galleryGrid"></div></div>
        </div>
    </main>

    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">
    <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handlePhotoUpload(this)">
    
    <!-- æ—¥æ›† Modal (ä¿æŒåŸæ¨£) -->
    <div id="calendarModal" class="fixed inset-0 bg-black/50 hidden z-[1000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[350px] p-5 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-2">
                <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-100 rounded"><i class="ri-arrow-left-s-line"></i></button><div class="font-bold text-lg" id="calMonthTitle"></div><button onclick="changeMonth(1)" class="p-1 hover:bg-slate-100 rounded"><i class="ri-arrow-right-s-line"></i></button>
            </div>
            <div class="flex gap-2 mb-3 text-xs"><button onclick="calFilter('all')" class="flex-1 py-1 border rounded">å…¨é¸</button><button onclick="calFilter('noWeekend')" class="flex-1 py-1 border rounded">æ’é™¤å…­æ—¥</button><button onclick="calFilter('onlyWeekend')" class="flex-1 py-1 border rounded">åƒ…é¸å…­æ—¥</button><button onclick="calClear()" class="px-2 py-1 border text-red-500 rounded">æ¸…</button></div>
            <div class="calendar-grid text-sm font-bold text-slate-400 mb-1"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
            <div id="calGrid" class="calendar-grid"></div>
            <div class="mt-4 flex justify-end gap-2"><button onclick="$('#calendarModal').classList.add('hidden')" class="px-4 py-2 bg-slate-100 rounded">å–æ¶ˆ</button><button onclick="confirmDate()" class="px-4 py-2 bg-blue-600 text-white rounded">ç¢ºå®š</button></div>
        </div>
    </div>

    <script>
        const $ = (s) => document.querySelector(s);
        let inputData=[], historyData=[], auditLogs={}; 
        let currentCalRow=null, selectedDates=new Set(), currentYear=2025, currentMonth=1;
        let uploadTarget=null;

        window.onload = function() { 
            addInputRow(); 
            loadHistory(true); 
            
            const now = new Date();
            const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            $('#auditMonthLabel').innerText = `çµ±è¨ˆæœˆä»½ï¼š${now.getFullYear()-1911}å¹´ ${now.getMonth()+1}æœˆ (${ym})`;
            
            // åˆå§‹åŒ–é¸å–®
            initAuditDropdowns();
        };

        function switchPage(page) {
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            if(document.getElementById(`nav-${page}`)) document.getElementById(`nav-${page}`).classList.add('active');
            ['input','audit','history','gallery'].forEach(p => { $(`#page-${p}`).classList.add('hidden'); $(`#page-${p}`).classList.remove('flex'); });
            const target = $(`#page-${page}`); target.classList.remove('hidden');
            if(page !== 'input') target.classList.add('flex');
            if(page === 'gallery') renderGallery();
        }

        // ============================
        // ç¨½æ ¸é‚è¼¯ (æ ¸å¿ƒ)
        // ============================
        function initAuditDropdowns() {
            const selBat = $('#selBat');
            selBat.innerHTML = '<option value="">è«‹é¸æ“‡å¤§éšŠ...</option>';
            Object.keys(AUDIT_UNITS).forEach(bat => {
                selBat.innerHTML += `<option value="${bat}">${bat}</option>`;
            });
        }

        function renderSquadSelect() {
            const bat = $('#selBat').value;
            const selSquad = $('#selSquad');
            const area = $('#unitCheckArea');
            
            area.classList.add('hidden');
            selSquad.innerHTML = '<option value="">è«‹é¸æ“‡ä¸­éšŠ...</option>';
            selSquad.disabled = true;

            if(bat) {
                selSquad.disabled = false;
                selSquad.innerHTML += '<option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>';
                Object.keys(AUDIT_UNITS[bat]).forEach(sq => {
                    selSquad.innerHTML += `<option value="${sq}">${sq}</option>`;
                });
            }
        }

        function renderUnitCheckboxes() {
            const bat = $('#selBat').value;
            const sq = $('#selSquad').value;
            const grid = $('#unitCheckboxGrid');
            const area = $('#unitCheckArea');

            if(!bat || !sq) { area.classList.add('hidden'); return; }
            
            area.classList.remove('hidden');
            grid.innerHTML = '';

            let unitsToShow = [];
            if(sq === 'ALL') {
                // é¡¯ç¤ºè©²å¤§éšŠä¸‹æ‰€æœ‰ä¸­éšŠçš„æ‰€æœ‰åˆ†éšŠ
                Object.values(AUDIT_UNITS[bat]).forEach(arr => unitsToShow.push(...arr));
            } else {
                unitsToShow = AUDIT_UNITS[bat][sq];
            }

            unitsToShow.forEach(u => {
                const div = document.createElement('div');
                div.className = 'audit-card';
                div.innerHTML = `
                    <label class="flex items-center gap-2 cursor-pointer w-full">
                        <input type="checkbox" name="auditUnit" value="${u}" class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm font-bold text-slate-700 select-none">${u}</span>
                    </label>
                `;
                grid.appendChild(div);
            });
        }

        function toggleAllUnits() {
            const checkboxes = document.querySelectorAll('input[name="auditUnit"]');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
        }

        function submitAudit() {
            const checked = Array.from(document.querySelectorAll('input[name="auditUnit"]:checked')).map(c => c.value);
            if(checked.length === 0) return alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹å–®ä½');

            const type = document.querySelector('input[name="auditType"]:checked').value;
            const now = new Date();
            const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

            // æº–å‚™æ‰¹æ¬¡è³‡æ–™
            const payload = checked.map(u => ({ ym: ym, unit: u, type: type }));

            showLoading("é€å‡ºç¢ºèªä¸­...");
            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify({ mode: 'update_audit', data: payload }),
                headers: { 'Content-Type': 'text/plain' }
            })
            .then(res => res.json())
            .then(json => {
                if(json.status === 'success') {
                    alert(`æˆåŠŸç¢ºèª ${json.count} ç­†è³‡æ–™`);
                    // æ›´æ–°æœ¬åœ°é¡¯ç¤º
                    checked.forEach(u => auditLogs[`${ym}_${u}`] = type);
                    renderAlertBanner(); // æ›´æ–°ä¸Šæ–¹è­¦ç¤º
                    updateAuditLogTable(); // æ›´æ–°ä¸‹æ–¹åˆ—è¡¨
                    // æ¸…ç©ºå‹¾é¸
                    document.querySelectorAll('input[name="auditUnit"]').forEach(c => c.checked = false);
                } else alert('å¤±æ•—');
            })
            .finally(() => hideLoading());
        }

        // ============================
        // è­¦ç¤ºèˆ‡è¼‰å…¥
        // ============================
        function loadHistory(refresh = false) {
            if(GAS_API_URL.includes("è«‹å¡«å…¥")) return;
            showLoading("è³‡æ–™åŒæ­¥ä¸­...");
            fetch(GAS_API_URL).then(r => r.json()).then(json => {
                if (json.status === 'success') {
                    historyData = json.data;
                    historyData.forEach(r => r.date = fixYearFormat(r.date));
                    
                    if(json.audit) {
                        auditLogs = {};
                        json.audit.forEach(log => auditLogs[`${log.ym}_${log.unit}`] = log.type);
                    }
                    renderHistoryTable();
                    renderAlertBanner();
                    updateAuditLogTable();
                }
            }).finally(() => hideLoading());
        }

        function renderAlertBanner() {
            const now = new Date();
            const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            const rocYm = `${now.getFullYear()-1911}å¹´${now.getMonth()+1}æœˆ`;
            
            let missing = [];
            
            // éæ­·æ‰€æœ‰æ‡‰å¡«å ±å–®ä½
            for (const [bat, squads] of Object.entries(AUDIT_UNITS)) {
                let batMissing = [];
                Object.values(squads).flat().forEach(u => {
                    if (!auditLogs[`${ym}_${u}`]) batMissing.push(u);
                });
                if (batMissing.length > 0) {
                    missing.push(`<strong>${bat}</strong>ï¼š${batMissing.join('ã€')}`);
                }
            }

            const banner = $('#alertBanner');
            if (missing.length > 0) {
                banner.classList.remove('hidden');
                $('#alertTitle').innerText = `âš ï¸ ${rocYm} å°šæœªçµæ¡ˆæé†’ (å‰©é¤˜ ${missing.reduce((acc,s)=>acc+s.split('ã€').length,0) - missing.length} å€‹å–®ä½)`;
                $('#alertContent').innerHTML = missing.join('<br>');
            } else {
                banner.classList.add('hidden');
            }
        }

        function updateAuditLogTable() {
            const tbody = $('#auditLogBody');
            const now = new Date();
            const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            
            // ç¯©é¸æœ¬æœˆå·²ç¢ºèªçš„
            const logs = Object.entries(auditLogs)
                .filter(([k, v]) => k.startsWith(ym))
                .map(([k, v]) => ({ unit: k.split('_')[1], type: v }));

            if(logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-400">æœ¬æœˆå°šç„¡ç¢ºèªç´€éŒ„</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(l => {
                const color = l.type === 'å·²å¡«å¯«' ? 'text-emerald-600 bg-emerald-50' : 'text-blue-600 bg-blue-50';
                return `
                    <tr class="border-b border-slate-100 last:border-0">
                        <td class="px-4 py-2 font-bold text-slate-700">${l.unit}</td>
                        <td class="px-4 py-2"><span class="px-2 py-1 rounded text-xs font-bold ${color}">${l.type}</span></td>
                        <td class="px-4 py-2 text-xs text-slate-400">å·²åŒæ­¥</td>
                    </tr>`;
            }).join('');
        }

        // å…¶ä»–åŸºç¤å‡½å¼ (æ–°å¢ã€åˆªé™¤åˆ—ã€æ—¥æ›†ç­‰) ä¿æŒåŸæ¨£
        function addInputRow() { inputData.push({date:'',unit:'',loc:'',item:'',session:'',people:'',note:''}); renderInputTable(); }
        function removeInputRow(i) { if(inputData.length>1) inputData.splice(i,1); else inputData[0]={date:'',unit:'',loc:'',item:'',session:'',people:'',note:''}; renderInputTable(); }
        function renderInputTable() { 
            $('#inputBody').innerHTML = inputData.map((r,i) => `<tr><td class="text-center"><button onclick="removeInputRow(${i})" class="text-slate-300 hover:text-red-500"><i class="ri-close-circle-fill text-xl"></i></button></td><td class="text-center text-slate-400 font-mono">${i+1}</td><td><div class="flex items-center h-full"><input type="text" value="${r.date}" onchange="inputData[${i}].date=this.value" placeholder="é¸æ—¥æœŸ"><button onclick="openCalendar(${i})" class="w-8 h-full bg-slate-50 border-l hover:text-blue-600"><i class="ri-calendar-line"></i></button></div></td><td><input type="text" value="${r.unit}" onchange="inputData[${i}].unit=this.value"></td><td><input type="text" value="${r.loc}" onchange="inputData[${i}].loc=this.value"></td><td><input type="text" value="${r.item}" onchange="inputData[${i}].item=this.value"></td><td><input type="number" value="${r.session}" onchange="inputData[${i}].session=this.value"></td><td><input type="number" value="${r.people}" onchange="inputData[${i}].people=this.value"></td><td><input type="text" value="${r.note}" onchange="inputData[${i}].note=this.value"></td></tr>`).join('');
        }
        function saveToCloud() {
            const valid = inputData.filter(r=>r.date||r.item);
            if(!valid.length) return alert('ç„¡è³‡æ–™');
            showLoading("å„²å­˜ä¸­...");
            fetch(GAS_API_URL, { method:'POST', body:JSON.stringify({mode:'append', data:valid}) }).then(r=>r.json()).then(j=>{ 
                if(j.status==='success') { alert('å„²å­˜æˆåŠŸ'); inputData=[]; addInputRow(); loadHistory(); } else alert('å¤±æ•—');
            }).finally(()=>hideLoading());
        }
        function renderHistoryTable() {
            let s=0, p=0;
            $('#historyBody').innerHTML = historyData.map((r,i) => {
                s+=parseInt(r.session)||0; p+=parseInt(r.people)||0;
                let btn = r.folderUrl ? `<a href="${r.folderUrl}" target="_blank" class="text-blue-600 underline">å·²å»ºæª”</a>` : `<button onclick="triggerUpload(${i})" class="text-slate-400 hover:text-blue-500"><i class="ri-camera-line"></i></button>`;
                return `<tr class="${i%2?'bg-slate-50':'bg-white'}"><td class="text-center text-xs text-slate-400">${i+1}</td><td class="px-2">${r.date}</td><td class="px-2 text-sm">${r.unit}</td><td class="px-2 text-sm">${r.loc}</td><td class="px-2">${r.item}</td><td class="text-center font-bold text-blue-600">${r.session}</td><td class="text-center font-bold text-emerald-600">${r.people}</td><td class="px-2 text-xs text-slate-400">${r.note}</td><td class="text-center">${btn}</td></tr>`;
            }).join('');
            $('#histTotalSession').innerText=s; $('#histTotalPeople').innerText=p;
        }
        
        // è¼”åŠ©åŠŸèƒ½
        function showLoading(m) { $('#loadingText').innerText=m; $('#loading').style.display='flex'; }
        function hideLoading() { $('#loading').style.display='none'; }
        function fixYearFormat(s) { return s?s.replace(/^0+(11\d)/,'$1'):""; }
        function triggerUpload(i) { uploadTarget=historyData[i]; $('#photoInput').click(); }
        async function handlePhotoUpload(inp) { /* åŒä¸Šå€‹ç‰ˆæœ¬ */ }
        function downloadTemplate() { saveAs(new Blob(["æ—¥æœŸ,å–®ä½,åœ°é»,é …ç›®,å ´æ¬¡,äººæ•¸,å‚™è¨»\n114å¹´1æœˆ1æ—¥,ä¿¡ç¾©ä¸­éšŠ,é§åœ°,è¨“ç·´,1,20,"],{type:'text/csv'}), "ç¯„æœ¬.csv"); }
        function processCSV(inp) { /* åŒä¸Šå€‹ç‰ˆæœ¬ */ }
        
        // æ—¥æ›†èˆ‡åŒ¯å‡ºåŠŸèƒ½ (çœç•¥ï¼Œä¿æŒåŸæ¨£)
        function openCalendar(i){ currentCalRow=i; selectedDates.clear(); renderCalendarGrid(); $('#calendarModal').classList.remove('hidden'); $('#calendarModal').classList.add('flex'); }
        function renderCalendarGrid() { /* ... */ }
        function changeMonth(d) { /* ... */ }
        function calFilter(t) { /* ... */ }
        function calClear() { /* ... */ }
        function confirmDate() { /* ... */ }
        async function exportExcel(m) { /* ... */ }
        function renderGallery() { /* ... */ }
    </script>
</body>
</html>
