<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電動車安全救援訓練統計系統</title>
    
    <!-- 工具庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        // ==========================================
        // ⚠️ 請在此貼上您的 Google Apps Script 網址
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycby-7BbY5cm6BdLcGkVzQrZQP8h7K29i5P6L8pSpVQYp-OKKFJLwR6bad_AR9hKzUxH7/exec";
        // ==========================================
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* 表格樣式 */
        .table-container { overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        table { width: 100%; min-width: 1000px; border-collapse: collapse; }
        th { background-color: #f1f5f9; color: #475569; font-weight: 700; padding: 12px; border: 1px solid #cbd5e1; white-space: nowrap; }
        td { border: 1px solid #cbd5e1; padding: 0; height: 42px; vertical-align: middle; }
        
        /* 輸入框優化 */
        input[type="text"], input[type="number"] { width: 100%; height: 100%; border: none; text-align: center; background: transparent; outline: none; font-size: 14px; }
        input:focus { background-color: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }
        
        /* 灰底欄位 (表示過渡期可能為空) */
        .col-gray { background-color: #f8fafc; }
        .col-gray input::placeholder { color: #cbd5e1; font-size: 12px; }

        /* 總計列 */
        .total-row td { background-color: #fff7ed; font-weight: bold; color: #c2410c; border-top: 2px solid #fdba74; text-align: center; font-size: 15px; }

        /* 按鈕樣式 */
        .btn { padding: 8px 16px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s; cursor: pointer; }
        .btn-primary { background: #0f172a; color: white; }
        .btn-primary:hover { background: #1e293b; }
        .btn-success { background: #059669; color: white; }
        .btn-success:hover { background: #047857; }
        .btn-outline { border: 1px solid #cbd5e1; background: white; color: #475569; }
        .btn-outline:hover { background: #f1f5f9; border-color: #94a3b8; }
        
        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 50; color: white; backdrop-filter: blur(2px); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading"><div class="text-xl font-bold animate-pulse">處理中...</div></div>

    <!-- 標題區 -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i class="ri-charging-pile-2-line text-blue-600"></i> 電動車安全救援訓練統計系統
            </h1>
            <p class="text-sm text-slate-500 mt-1">過渡期併行版本 (支援民國年、雙模式輸出)</p>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-outline" onclick="$('#csvInput').click()"><i class="ri-upload-2-line"></i> 匯入 CSV</button>
            <button class="btn btn-primary" onclick="saveData()"><i class="ri-save-3-line"></i> 儲存至雲端</button>
            <div class="relative group">
                <button class="btn btn-success"><i class="ri-file-excel-2-line"></i> 下載報表</button>
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-slate-200 hidden group-hover:block z-10">
                    <div class="p-1">
                        <button onclick="exportExcel('full')" class="w-full text-left px-4 py-2 hover:bg-slate-50 rounded text-sm text-slate-700">完整版 (含單位/地點)</button>
                        <button onclick="exportExcel('report')" class="w-full text-left px-4 py-2 hover:bg-slate-50 rounded text-sm text-slate-700 font-bold text-blue-600">陳報上級版 (精簡)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 表格區 -->
    <div class="table-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th style="width: 50px;">刪除</th>
                    <th style="width: 60px;">項次</th>
                    <th style="width: 250px;">日期 (文字)</th>
                    <th style="width: 150px;">單位/層級</th>
                    <th style="width: 180px;">地點</th>
                    <th style="width: 250px;">訓練項目</th>
                    <th style="width: 80px;">辦理<br>場次</th>
                    <th style="width: 80px;">參與<br>人數</th>
                    <th style="width: 150px;">備註</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- 資料列由 JS 生成 -->
            </tbody>
            <tfoot class="total-row">
                <tr>
                    <td colspan="6" class="text-right pr-4">總計</td>
                    <td id="totalSession">0</td>
                    <td id="totalPeople">0</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="mt-4 flex justify-center">
        <button class="btn btn-outline w-full md:w-auto justify-center" onclick="addRow()"><i class="ri-add-line"></i> 新增一列</button>
    </div>

    <!-- 隱藏的 CSV 輸入 -->
    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">

    <script>
        const $ = (s) => document.querySelector(s);
        let tableData = []; // 儲存所有資料的陣列

        // 初始化
        window.onload = function() {
            loadData();
        };

        // ========================
        // 核心資料操作
        // ========================
        function addRow(data = {}) {
            // 預設空資料結構
            const newRow = {
                id: data.id || (tableData.length + 1),
                date: data.date || '',
                unit: data.unit || '',
                loc: data.loc || '',
                item: data.item || '',
                session: data.session || 0,
                people: data.people || 0,
                note: data.note || ''
            };
            tableData.push(newRow);
            renderTable();
        }

        function deleteRow(index) {
            if(confirm('確定刪除此列？')) {
                tableData.splice(index, 1);
                renderTable(); // 重新渲染會自動重算項次
            }
        }

        function renderTable() {
            const tbody = $('#tableBody');
            tbody.innerHTML = '';
            
            let sumSession = 0;
            let sumPeople = 0;

            tableData.forEach((row, index) => {
                // 更新項次 (確保連續)
                row.id = index + 1;
                
                // 加總計算
                sumSession += parseInt(row.session) || 0;
                sumPeople += parseInt(row.people) || 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center"><button onclick="deleteRow(${index})" class="text-slate-300 hover:text-red-500"><i class="ri-close-circle-fill text-xl"></i></button></td>
                    <td class="text-center text-slate-400 font-mono">${row.id}</td>
                    <td><input type="text" value="${row.date}" onchange="updateData(${index}, 'date', this.value)" placeholder="例: 114年1月..."></td>
                    <td class="col-gray"><input type="text" value="${row.unit}" onchange="updateData(${index}, 'unit', this.value)" placeholder="(選填)"></td>
                    <td class="col-gray"><input type="text" value="${row.loc}" onchange="updateData(${index}, 'loc', this.value)" placeholder="(選填)"></td>
                    <td><input type="text" value="${row.item}" onchange="updateData(${index}, 'item', this.value)"></td>
                    <td><input type="number" value="${row.session}" onchange="updateData(${index}, 'session', this.value)"></td>
                    <td><input type="number" value="${row.people}" onchange="updateData(${index}, 'people', this.value)"></td>
                    <td><input type="text" value="${row.note}" onchange="updateData(${index}, 'note', this.value)"></td>
                `;
                tbody.appendChild(tr);
            });

            // 更新總計顯示
            $('#totalSession').innerText = sumSession;
            $('#totalPeople').innerText = sumPeople;
        }

        function updateData(index, field, value) {
            tableData[index][field] = value;
            if (field === 'session' || field === 'people') renderTable(); // 若改數字則重繪以更新總計
        }

        // ========================
        // 雲端存取 (GAS)
        // ========================
        function loadData() {
            if (GAS_API_URL.includes("請將此處")) { 
                // 尚未設定網址時，給一列預設空資料
                addRow(); 
                return; 
            }

            $('#loading').style.display = 'flex';
            fetch(GAS_API_URL)
                .then(res => res.json())
                .then(json => {
                    if (json.status === 'success') {
                        // 清空目前並載入
                        tableData = []; 
                        if (json.data && json.data.length > 0) {
                            json.data.forEach(r => tableData.push(r));
                        } else {
                            addRow(); // 若雲端沒資料，至少給一列
                        }
                        renderTable();
                    } else {
                        alert('讀取失敗: ' + json.message);
                    }
                })
                .catch(err => alert('連線錯誤'))
                .finally(() => $('#loading').style.display = 'none');
        }

        function saveData() {
            if (GAS_API_URL.includes("請將此處")) { alert("請先設定 GAS_API_URL"); return; }
            
            $('#loading').style.display = 'flex';
            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify({ data: tableData }), // 包裝成 data 物件
                headers: { 'Content-Type': 'text/plain' }
            })
            .then(res => res.json())
            .then(json => {
                if (json.status === 'success') alert('儲存成功！');
                else alert('儲存失敗: ' + json.message);
            })
            .catch(err => alert('連線錯誤'))
            .finally(() => $('#loading').style.display = 'none');
        }

        // ========================
        // CSV 匯入 (舊資料相容邏輯)
        // ========================
        function processCSV(input) {
            if (!input.files[0]) return;
            const file = input.files[0];
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    const imported = results.data;
                    let count = 0;
                    
                    imported.forEach(r => {
                        // 智慧判斷欄位名稱 (相容舊 Excel 標頭)
                        // 舊 Excel: 項次, 日期, 訓練項目, 辦理場次, 參與人數
                        
                        // 尋找對應欄位 (防止 Excel 欄位名稱有空白)
                        const getVal = (keys) => {
                            for (let k of Object.keys(r)) {
                                if (keys.some(key => k.includes(key))) return r[k];
                            }
                            return '';
                        };

                        tableData.push({
                            id: tableData.length + 1,
                            date: getVal(['日期', 'Date']) || '',
                            unit: getVal(['單位', 'Unit']) || '', // 舊資料會是空字串 (Option A)
                            loc: getVal(['地點', 'Location']) || '', // 舊資料會是空字串 (Option A)
                            item: getVal(['項目', 'Item', '名稱']) || '',
                            session: getVal(['場次', 'Session']) || 0,
                            people: getVal(['人數', 'Participants']) || 0,
                            note: getVal(['備註', 'Note']) || ''
                        });
                        count++;
                    });
                    
                    renderTable();
                    alert(`成功匯入 ${count} 筆資料`);
                    input.value = ''; // 重置 input
                }
            });
        }

        // ========================
        // 雙模式 Excel 匯出
        // ========================
        async function exportExcel(mode) {
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('電動車訓練統計');

            // 標題樣式
            const headerStyle = {
                font: { bold: true, color: { argb: 'FFFFFFFF' } },
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F2937' } }, // 深灰色底
                alignment: { horizontal: 'center' },
                border: { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} }
            };

            // 資料樣式
            const cellStyle = {
                border: { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} },
                alignment: { vertical: 'middle' }
            };

            // 定義欄位 (根據模式)
            let columns = [];
            if (mode === 'full') {
                // 完整版
                columns = [
                    { header: '項次', key: 'id', width: 8 },
                    { header: '日期', key: 'date', width: 30 },
                    { header: '單位/層級', key: 'unit', width: 20 },
                    { header: '地點', key: 'loc', width: 25 },
                    { header: '訓練項目', key: 'item', width: 35 },
                    { header: '辦理場次', key: 'session', width: 10 },
                    { header: '參與人數', key: 'people', width: 10 },
                    { header: '備註', key: 'note', width: 20 }
                ];
            } else {
                // 陳報上級版 (隱藏 單位、地點、備註)
                columns = [
                    { header: '項次', key: 'id', width: 8 },
                    { header: '日期', key: 'date', width: 30 },
                    { header: '訓練項目', key: 'item', width: 40 },
                    { header: '辦理場次', key: 'session', width: 12 },
                    { header: '參與人數', key: 'people', width: 12 }
                ];
            }

            ws.columns = columns;

            // 套用標題樣式
            ws.getRow(1).eachCell((cell) => {
                cell.style = headerStyle;
            });

            // 填入資料
            tableData.forEach(row => {
                ws.addRow(row).eachCell((cell) => {
                    cell.style = cellStyle;
                    // 置中對齊特定欄位
                    if (cell.col != 3 && cell.col != 5) cell.alignment = { horizontal: 'center', vertical: 'middle' }; 
                });
            });

            // 加入總計列
            const totalRowValues = {};
            if (mode === 'full') {
                totalRowValues.item = '總計';
                totalRowValues.session = $('#totalSession').innerText;
                totalRowValues.people = $('#totalPeople').innerText;
            } else {
                totalRowValues.item = '總計'; // 在陳報版，"訓練項目"是第3欄
                totalRowValues.session = $('#totalSession').innerText;
                totalRowValues.people = $('#totalPeople').innerText;
            }
            
            const lastRow = ws.addRow(totalRowValues);
            lastRow.eachCell((cell) => {
                cell.font = { bold: true, color: { argb: 'FFC2410C' } };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF7ED' } };
                cell.border = { top: {style:'double'}, bottom: {style:'thick'} };
                cell.alignment = { horizontal: 'center' };
            });

            // 檔名
            const fileName = mode === 'full' ? '電動車訓練_完整資料庫.xlsx' : '電動車訓練_陳報統計表.xlsx';
            
            const buffer = await wb.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), fileName);
        }
    </script>
</body>
</html>
